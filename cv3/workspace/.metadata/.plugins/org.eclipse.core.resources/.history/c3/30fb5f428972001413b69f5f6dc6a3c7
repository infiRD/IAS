
AS=nasm
LD=ld

ifeq ($(OS),Windows_NT)
	SOURCES=main.asm
	LDFLAGS=-LC:\windows\system32 -lkernel32 -LC:\windows\system32 -lmsvcrt
	ASFLAGS=-f win32 -g -O0 --prefix _
	EXECUTABLE=main.exe
else
	SOURCES=main_lin.asm
	LDFLAGS=
	ASFLAGS=-f elf64 -F dwarf -g
	EXECUTABLE=main
endif

OBJECTS=$(SOURCES:%.asm=%.o)

all: ASFLAGS += -p libs/libIAS_ld.asm
all: clean compile

compile: $(SOURCES) $(EXECUTABLE)

$(EXECUTABLE): $(OBJECTS)
	$(LD) -o $@ $(OBJECTS) ${LDFLAGS}

$(OBJECTS): $(SOURCES)
	$(AS) $(ASFLAGS) -o $@ $<
	
clean:
ifeq ($(OS),Windows_NT)
	del ${OBJECTS} $(EXECUTABLE)
else
	rm -f ${OBJECTS} $(EXECUTABLE)
endif

test: all do_tests

do_tests: 
	$(EXECUTABLE)
	del ${OBJECTS} $(EXECUTABLE)
	